/*!
 * Tiny Templates plugin
 *
 * Copyright (c) 2023 Ephox Corporation DBA Tiny Technologies, Inc.
 * Licensed under the Tiny commercial license. See https://www.tiny.cloud/legal/
 *
 * Version: 7.8.0-392
 */

!function(){"use strict";const e=e=>parseInt(e,10),t=(e,t)=>{const n=e-t;return 0===n?0:n>0?1:-1},n=(e,t,n)=>({major:e,minor:t,patch:n}),a=t=>{const a=/([0-9]+)\.([0-9]+)\.([0-9]+)(?:(\-.+)?)/.exec(t);return a?n(e(a[1]),e(a[2]),e(a[3])):n(0,0,0)},r=e=>t=>(e=>{const t=typeof e;return null===e?"null":"object"===t&&Array.isArray(e)?"array":"object"===t&&(n=a=e,(r=String).prototype.isPrototypeOf(n)||(null===(o=a.constructor)||void 0===o?void 0:o.name)===r.name)?"string":t;var n,a,r,o})(t)===e,o=e=>t=>typeof t===e,i=r("string"),s=r("object"),l=r("array"),c=o("boolean"),m=e=>undefined===e;const d=e=>!(e=>null==e)(e),p=o("function"),u=o("number"),g=e=>{let t=e;return{get:()=>t,set:e=>{t=e}}},v=()=>{},h=e=>()=>e,y=e=>e,f=e=>e(),w=h(!1),_=h(!0);class b{constructor(e,t){this.tag=e,this.value=t}static some(e){return new b(!0,e)}static none(){return b.singletonNone}fold(e,t){return this.tag?t(this.value):e()}isSome(){return this.tag}isNone(){return!this.tag}map(e){return this.tag?b.some(e(this.value)):b.none()}bind(e){return this.tag?e(this.value):b.none()}exists(e){return this.tag&&e(this.value)}forall(e){return!this.tag||e(this.value)}filter(e){return!this.tag||e(this.value)?this:b.none()}getOr(e){return this.tag?this.value:e}or(e){return this.tag?this:e}getOrThunk(e){return this.tag?this.value:e()}orThunk(e){return this.tag?this:e()}getOrDie(e){if(this.tag)return this.value;throw new Error(null!=e?e:"Called getOrDie on None")}static from(e){return d(e)?b.some(e):b.none()}getOrNull(){return this.tag?this.value:null}getOrUndefined(){return this.value}each(e){this.tag&&e(this.value)}toArray(){return this.tag?[this.value]:[]}toString(){return this.tag?`some(${this.value})`:"none()"}}b.singletonNone=new b(!1);const x=Array.prototype.slice,S=Array.prototype.indexOf,C=Array.prototype.push,O=(e,t)=>((e,t)=>S.call(e,t))(e,t)>-1,A=(e,t)=>{const n=e.length,a=new Array(n);for(let r=0;r<n;r++){const n=e[r];a[r]=t(n,r)}return a},E=(e,t)=>{for(let n=0,a=e.length;n<a;n++)t(e[n],n)},T=(e,t)=>{const n=[];for(let a=0,r=e.length;a<r;a++){const r=e[a];t(r,a)&&n.push(r)}return n},D=(e,t)=>((e,t,n)=>{for(let a=0,r=e.length;a<r;a++){const r=e[a];if(t(r,a))return b.some(r);if(n(r,a))break}return b.none()})(e,t,w),k=(e,t)=>{for(let n=0,a=e.length;n<a;n++)if(t(e[n],n))return b.some(n);return b.none()},P=(e,t)=>(e=>{const t=[];for(let n=0,a=e.length;n<a;++n){if(!l(e[n]))throw new Error("Arr.flatten item "+n+" was not an array, input: "+e);C.apply(t,e[n])}return t})(A(e,t)),I=(e,t)=>{for(let n=0,a=e.length;n<a;++n)if(!0!==t(e[n],n))return!1;return!0};class R extends Error{constructor(e){super(e),this.name="AdvTemplateError"}}const M=e=>{const t=t=>t(e),n=h(e),a=()=>r,r={tag:!0,inner:e,fold:(t,n)=>n(e),isValue:_,isError:w,map:t=>N.value(t(e)),mapError:a,bind:t,exists:t,forall:t,getOr:n,or:a,getOrThunk:n,orThunk:a,getOrDie:n,each:t=>{t(e)},toOptional:()=>b.some(e)};return r},$=e=>{const t=()=>n,n={tag:!1,inner:e,fold:(t,n)=>t(e),isValue:w,isError:_,map:t,mapError:t=>N.error(t(e)),bind:t,exists:w,forall:_,getOr:y,or:y,getOrThunk:f,orThunk:f,getOrDie:(a=String(e),()=>{throw new Error(a)}),each:v,toOptional:b.none};var a;return n},N={value:M,error:$,fromOption:(e,t)=>e.fold((()=>$(t)),M)},j=Object.keys,L=Object.hasOwnProperty,B=(e,t)=>{const n=j(e);for(let a=0,r=n.length;a<r;a++){const r=n[a];t(e[r],r)}},F=(e,t)=>L.call(e,t),z=e=>i(e)&&e.length>0,V=e=>z(e),U=e=>F(e,"id")&&V(e.id),W=e=>F(e,"title")&&z(e.title),K=e=>F(e,"content")&&z(e.content),q=e=>s(e)&&U(e)&&W(e)&&F(e,"items")&&Q(e.items),H=e=>e.locked||!1,G=(e,t)=>J(e.id,t).exists(H),J=(e,t)=>D(t,(t=>q(t)&&O(A(t.items,(({id:e})=>e)),e))),Y=e=>s(e)&&U(e)&&W(e)&&(e=>!F(e,"items")||Q(e.items))(e),Q=e=>l(e)&&I(e,Y),X=e=>F(e,"items")&&ee(e.items),Z=e=>s(e)&&W(e)&&((e=>K(e))(e)||X(e)),ee=e=>l(e)&&I(e,Z),te=(e,t)=>n=>e(n)?N.value(n):N.error(t),ne=te((e=>s(e)&&(e=>{for(const t in e)if(L.call(e,t))return!1;return!0})(e)),"response should contain empty object"),ae=te((e=>s(e)&&U(e)),"response should contain id"),re=te((e=>s(e)&&U(e)&&W(e)&&K(e)),"response contains invalid template data"),oe=e=>Q(e)?(e=>{const t=e=>P(e,(e=>q(e)?[e.id,...t(e.items)]:[e.id])),n=t(e);return n.length===[...new Set(n)].length})(e)?N.value(e):N.error("response contains duplicated ids"):N.error("response contains invalid data"),ie=e=>t=>t.options.get(e),se=e=>{const t=(t,n)=>{var a,r;a=t,r=(e,t)=>(...a)=>((e,t,n)=>{return s(a=n)&&p(a.then)&&p(a.catch)?n.then((n=>t(n).fold((t=>Promise.reject(new R(`${e} ${t}`))),(e=>Promise.resolve(e))))):Promise.reject(new R(`${e} should return a Promise`));var a})(e,n,t(...a)),e.options.register(a,{processor:e=>p(e)?{valid:!0,value:r(a,e)}:{valid:!1,message:"Must be a function returning promise"},default:()=>Promise.reject(new R(`${a} option is not configured`))})};t("advtemplate_create_category",ae),t("advtemplate_rename_category",ne),t("advtemplate_move_category_items",ne),t("advtemplate_delete_category",ne),t("advtemplate_create_template",ae),t("advtemplate_rename_template",ne),t("advtemplate_update_template",ne),t("advtemplate_move_template",ne),t("advtemplate_get_template",re),t("advtemplate_delete_template",ne),t("advtemplate_delete_all",ne),t("advtemplate_list",oe),e.options.register("advtemplate_templates",{processor:ee})},le=ie("advtemplate_create_category"),ce=ie("advtemplate_rename_category"),me=ie("advtemplate_move_category_items"),de=ie("advtemplate_delete_category"),pe=ie("advtemplate_create_template"),ue=ie("advtemplate_rename_template"),ge=ie("advtemplate_move_template"),ve=ie("advtemplate_get_template"),he=ie("advtemplate_delete_template"),ye=ie("advtemplate_list"),fe=ie("advtemplate_templates"),we=ie("content_style"),_e=ie("body_class"),be=ie("content_css_cors"),xe=e=>{if(null==e)throw new Error("Node cannot be null or undefined");return{dom:e}},Se=(e,t)=>{const n=(t||document).createElement(e);return xe(n)},Ce=xe,Oe=e=>1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType||0===e.childElementCount;"undefined"!=typeof window?window:Function("return this;")();const Ae=e=>{const t=e.dom;null!==t.parentNode&&t.parentNode.removeChild(t)},Ee='data-mce-advtemplate-marker="clipboard"',Te=e=>{const t=((e,t)=>((e,t)=>{const n=void 0===t?document:t.dom;return Oe(n)?[]:A(n.querySelectorAll(e),Ce)})(t,e))(Ce(e.getBody()),`span[${Ee}]`);return 0===t.length?Promise.resolve():(async()=>new Promise(((e,t)=>{var n;p(null===(n=null===navigator||void 0===navigator?void 0:navigator.clipboard)||void 0===n?void 0:n.readText)?navigator.clipboard.readText().then((t=>{e(t)})).catch((e=>{t(e)})):t(new Error("Clipboard API not supported in this browser."))})))().then((n=>{E(t,(t=>{const a=e.dom.createRng();a.setStartAfter(t.dom),a.setEndAfter(t.dom),e.selection.setRng(a),e.insertContent(n)}))})).catch((t=>{e.notificationManager.open({text:e.translate("Failed to read clipboard content"),type:"error",timeout:2e3}),console.error(t)})).finally((()=>{E(t,(e=>{Ae(e)}))}))},De='data-mce-advtemplate-marker="cursor"',ke="{{mce-cursor}}",Pe=new RegExp(ke),Ie=new RegExp("{{mce-clipboard}}","g"),Re='data-mce-bookmark="1"',Me=`<span ${Re} ${De}></span>`,$e=`<span ${Re} ${Ee}></span>`,Ne=async e=>{await Te(e),(e=>{((e,t)=>((e,t)=>{const n=void 0===t?document:t.dom;return Oe(n)?b.none():b.from(n.querySelector(e)).map(Ce)})(t,e))(Ce(e.getBody()),`span[${De}]`).each((t=>{const n=e.dom.createRng();n.setStartBefore(t.dom),n.setEndBefore(t.dom),e.selection.setRng(n),e.selection.scrollIntoView(),Ae(t)}))})(e)},je=(e,t)=>ve(e)(t).then((t=>{(async(e,t)=>{const n=g(!1),a=((e,t,n)=>{const a=tinymce.html.DomParser(void 0,e.schema);a.addNodeFilter("#text",(e=>t=>{let n,a=!1;for(const e of t){let t=!1;b.from(e.value).each((r=>{let o=r;if(!a){const e=o.match(Pe);d(e)&&(o=o.replace(ke,Me),a=!0,t=!0)}const i=o.match(Ie);if(d(i)&&(o=o.replace(Ie,$e),t=!0),t){n=null!=n?n:tinymce.html.DomParser();const t=n.parse(o);e.replace(t),t.unwrap()}}))}e.set(d(n))})(n));const r=a.parse(t,{insert:!0});return n.get()?tinymce.html.Serializer({validate:!0},e.schema).serialize(r):t})(e,t,n);e.insertContent(a),n.get()&&await Ne(e)})(e,t.content)})),Le=(e,t)=>e?b.some(t):b.none(),Be={text:"Uncategorized",value:""},Fe=(e,t)=>{const n=T(e,(e=>q(e)&&(!d(t)||e.id!==t)&&!H(e)));return[...t===Be.value?[]:[Be],...A(n,(({id:e,title:t})=>({text:t,value:e})))]},ze=(e,t)=>D(t,(t=>q(t)&&O(A(t.items,(({id:e})=>e)),e))).map((e=>e.id)).getOr(Be.value),Ve=e=>Le(e!==Be.value,e).getOrUndefined(),Ue=(e,t,n)=>e.options.isSet(t)?[n]:[],We=(e,t,n,a)=>{const r=e=>{const t=[...Ue(a,"advtemplate_rename_category",{type:"menuitem",text:"Rename...",onAction:n.renameCategory(e)}),...Ue(a,"advtemplate_move_category_items",{type:"menuitem",text:"Move all items...",enabled:e.items.length>0,onAction:n.moveCategoryItems(e.id)}),...Ue(a,"advtemplate_delete_category",{type:"separator"}),...Ue(a,"advtemplate_delete_category",{type:"menuitem",icon:"remove",text:"Delete all",onAction:n.deleteCategory(e.id)})];return t.length>0?{menu:{type:"menubutton",icon:"image-options",fetch:e=>e(t),tooltip:"Category actions"}}:{}},o=e=>{const t=[...Ue(a,"advtemplate_rename_template",{type:"menuitem",text:"Rename...",onAction:n.renameTemplate(e)}),...Ue(a,"advtemplate_move_template",{type:"menuitem",text:"Move to...",onAction:n.moveTemplate(e.id)}),...Ue(a,"advtemplate_delete_template",{type:"separator"}),...Ue(a,"advtemplate_delete_template",{type:"menuitem",icon:"remove",text:"Delete",onAction:n.deleteTemplate(e.id)})];return t.length>0?{menu:{type:"menubutton",icon:"image-options",fetch:e=>e(t),tooltip:"Template actions"}}:{}};return A(t,(t=>q(t)?(e=>({type:"directory",id:e.id,title:e.title,children:We(e,e.items,n,a),...H(e)?{customStateIcon:"lock",customStateIconTooltip:a.translate("Locked for editing")}:r(e)}))(t):(t=>({type:"leaf",id:t.id,title:t.title,...e&&H(e)?{customStateIcon:"lock",customStateIconTooltip:a.translate("Locked for editing")}:o(t)}))(t)))},Ke=e=>{const t=(e,n)=>((e,n,a)=>(E(e,((e,n)=>{var r,o;r=a,a="directory"===(o=e).type?[o,...t(o.children,r)]:[...r,o]})),a))(e,0,n);return t(e,[])},qe=e=>t=>{b.from(t.message).bind((e=>(console.error(e),Le(!(e=>e instanceof R)(t),e)))).or(b.some("Operation failed")).each(e.windowManager.alert)},He=(e,t)=>((e,t,n)=>{const a=((e,t)=>{const n=((e,t)=>{const n=e.dom.getAttribute(t);return null===n?void 0:n})(e,t);return void 0===n||""===n?[]:n.split(" ")})(e,t);return((e,t,n)=>{((e,t,n)=>{if(!(i(n)||c(n)||u(n)))throw console.error("Invalid call to Attribute.set. Key ",t,":: Value ",n,":: Element ",e),new Error("Attribute value was not simple");e.setAttribute(t,n+"")})(e.dom,t,n)})(e,t,a.concat([n]).join(" ")),!0})(e,"class",t),Ge=()=>Je(0,0),Je=(e,t)=>({major:e,minor:t}),Ye={nu:Je,detect:(e,t)=>{const n=String(t).toLowerCase();return 0===e.length?Ge():((e,t)=>{const n=((e,t)=>{for(let n=0;n<e.length;n++){const a=e[n];if(a.test(t))return a}})(e,t);if(!n)return{major:0,minor:0};const a=e=>Number(t.replace(n,"$"+e));return Je(a(1),a(2))})(e,n)},unknown:Ge},Qe=(e,t)=>{const n=String(t).toLowerCase();return D(e,(e=>e.search(n)))},Xe=(e,t,n=0,a)=>{const r=e.indexOf(t,n);return-1!==r&&(!!m(a)||r+t.length<=a)},Ze=(et=/^\s+|\s+$/g,e=>e.replace(et,""));var et;const tt=/.*?version\/\ ?([0-9]+)\.([0-9]+).*/,nt=e=>t=>Xe(t,e),at=[{name:"Edge",versionRegexes:[/.*?edge\/ ?([0-9]+)\.([0-9]+)$/],search:e=>Xe(e,"edge/")&&Xe(e,"chrome")&&Xe(e,"safari")&&Xe(e,"applewebkit")},{name:"Chromium",brand:"Chromium",versionRegexes:[/.*?chrome\/([0-9]+)\.([0-9]+).*/,tt],search:e=>Xe(e,"chrome")&&!Xe(e,"chromeframe")},{name:"IE",versionRegexes:[/.*?msie\ ?([0-9]+)\.([0-9]+).*/,/.*?rv:([0-9]+)\.([0-9]+).*/],search:e=>Xe(e,"msie")||Xe(e,"trident")},{name:"Opera",versionRegexes:[tt,/.*?opera\/([0-9]+)\.([0-9]+).*/],search:nt("opera")},{name:"Firefox",versionRegexes:[/.*?firefox\/\ ?([0-9]+)\.([0-9]+).*/],search:nt("firefox")},{name:"Safari",versionRegexes:[tt,/.*?cpu os ([0-9]+)_([0-9]+).*/],search:e=>(Xe(e,"safari")||Xe(e,"mobile/"))&&Xe(e,"applewebkit")}],rt=[{name:"Windows",search:nt("win"),versionRegexes:[/.*?windows\ nt\ ?([0-9]+)\.([0-9]+).*/]},{name:"iOS",search:e=>Xe(e,"iphone")||Xe(e,"ipad"),versionRegexes:[/.*?version\/\ ?([0-9]+)\.([0-9]+).*/,/.*cpu os ([0-9]+)_([0-9]+).*/,/.*cpu iphone os ([0-9]+)_([0-9]+).*/]},{name:"Android",search:nt("android"),versionRegexes:[/.*?android\ ?([0-9]+)\.([0-9]+).*/]},{name:"macOS",search:nt("mac os x"),versionRegexes:[/.*?mac\ os\ x\ ?([0-9]+)_([0-9]+).*/]},{name:"Linux",search:nt("linux"),versionRegexes:[]},{name:"Solaris",search:nt("sunos"),versionRegexes:[]},{name:"FreeBSD",search:nt("freebsd"),versionRegexes:[]},{name:"ChromeOS",search:nt("cros"),versionRegexes:[/.*?chrome\/([0-9]+)\.([0-9]+).*/]}],ot={browsers:h(at),oses:h(rt)},it=e=>{const t=e.current,n=e.version,a=e=>()=>t===e;return{current:t,version:n,isEdge:a("Edge"),isChromium:a("Chromium"),isIE:a("IE"),isOpera:a("Opera"),isFirefox:a("Firefox"),isSafari:a("Safari")}},st=()=>it({current:void 0,version:Ye.unknown()}),lt=it,ct=e=>{const t=e.current,n=e.version,a=e=>()=>t===e;return{current:t,version:n,isWindows:a("Windows"),isiOS:a("iOS"),isAndroid:a("Android"),isMacOS:a("macOS"),isLinux:a("Linux"),isSolaris:a("Solaris"),isFreeBSD:a("FreeBSD"),isChromeOS:a("ChromeOS")}},mt=()=>ct({current:void 0,version:Ye.unknown()}),dt=ct,pt=(e,t,n)=>{const a=ot.browsers(),r=ot.oses(),o=t.bind((e=>((e,t)=>((e,t)=>{for(let n=0;n<e.length;n++){const a=t(e[n]);if(a.isSome())return a}return b.none()})(t.brands,(t=>{const n=t.brand.toLowerCase();return D(e,(e=>{var t;return n===(null===(t=e.brand)||void 0===t?void 0:t.toLowerCase())})).map((e=>({current:e.name,version:Ye.nu(parseInt(t.version,10),0)})))})))(a,e))).orThunk((()=>((e,t)=>Qe(e,t).map((e=>{const n=Ye.detect(e.versionRegexes,t);return{current:e.name,version:n}})))(a,e))).fold(st,lt),i=((e,t)=>Qe(e,t).map((e=>{const n=Ye.detect(e.versionRegexes,t);return{current:e.name,version:n}})))(r,e).fold(mt,dt),s=((e,t,n,a)=>{const r=e.isiOS()&&!0===/ipad/i.test(n),o=e.isiOS()&&!r,i=e.isiOS()||e.isAndroid(),s=i||a("(pointer:coarse)"),l=r||!o&&i&&a("(min-device-width:768px)"),c=o||i&&!l,m=t.isSafari()&&e.isiOS()&&!1===/safari/i.test(n),d=!c&&!l&&!m;return{isiPad:h(r),isiPhone:h(o),isTablet:h(l),isPhone:h(c),isTouch:h(s),isAndroid:e.isAndroid,isiOS:e.isiOS,isWebView:h(m),isDesktop:h(d)}})(i,o,e,n);return{browser:o,os:i,deviceType:s}},ut=e=>window.matchMedia(e).matches;let gt=(e=>{let t,n=!1;return(...a)=>(n||(n=!0,t=e.apply(null,a)),t)})((()=>pt(window.navigator.userAgent,b.from(window.navigator.userAgentData),ut)));const vt=()=>gt(),ht=()=>{const e=vt().os.isMacOS()||vt().os.isiOS();return`<script>(${(e=>{document.addEventListener("click",(t=>{for(let n=t.target;n;n=n.parentNode)if("A"===n.nodeName){const a=n.getAttribute("href");if(a&&a.startsWith("#")){t.preventDefault();const e=document.getElementById(a.substring(1));return void(e&&e.scrollIntoView({behavior:"smooth"}))}(e?t.metaKey:t.ctrlKey&&!t.altKey)||t.preventDefault()}}),!1)}).toString()})(${e})<\/script>`},yt=(e,t)=>tinymce.html.Serializer({validate:!0},e.schema).serialize(e.parser.parse(t,{insert:!0})),ft=e=>`<style type="text/css">${e}</style>`,wt=(e,t)=>b.from(e).filter((e=>e.length>0)).map(t).getOr(""),_t=ft(".mce-advtemplate-preview-placeholder { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: #b1aeae; font-family: sans-serif; }"),bt=(e,t)=>{if(-1===t.indexOf("<html>")){const n=wt(we(e),ft),a=be(e)?' crossorigin="anonymous"':"",r=A(e.contentCSS,(t=>`<link type="text/css" rel="stylesheet" href="${e.documentBaseURI.toAbsolute(t)}"${a}>`)),o=e.dom.encode,i=`<base href="${o(e.documentBaseURI.getURI())}">`,s=wt(_e(e),(e=>` class="${o(e)}"`)),l=wt(e.getBody().dir,(e=>` dir="${o(e)}"`));return["<!DOCTYPE html><html><head>",i,r.join(""),_t,n,ht(),`</head><body${s}${l}>`,yt(e,t),"</body></html>"].join("")}return t},xt=e=>{const t=Se("div");var n,a;return a="mce-advtemplate-preview-placeholder",(e=>void 0!==e.dom.classList)(n=t)?n.dom.classList.add(a):He(n,a),((e,t)=>{e.dom.textContent=t})(t,e.translate("Select template to preview")),bt(e,(e=>{const t=Se("div");return((e,t)=>{e.dom.appendChild(t.dom)})(t,Ce(e.dom.cloneNode(!0))),(e=>e.dom.innerHTML)(t)})(t))},St=(e,t,n)=>({renameCategory:t=>()=>((e,t,n)=>{H(n)||e.windowManager.open({title:"Rename category",initialData:{title:n.title},body:{type:"panel",items:[{type:"input",name:"title",label:"Category name"}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onChange:e=>{const t=e.getData();e.setEnabled("save",t.title.length>0)},onSubmit:a=>{const{title:r}=a.getData();ce(e)(n.id,r).then((async()=>{await t(),a.close()})).catch(qe(e))}})})(e,n,t),renameTemplate:t=>()=>(async(e,t,n)=>{const a=await ye(e)(),r=await ve(e)(n.id);G(r,a)||e.windowManager.open({title:"Rename template",initialData:{title:n.title},body:{type:"panel",items:[{type:"input",name:"title",label:"Template name"}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onChange:e=>{const t=e.getData();e.setEnabled("save",t.title.length>0)},onSubmit:a=>{const{title:r}=a.getData();ue(e)(n.id,r).then((async()=>{await t(),a.close()})).catch(qe(e))}})})(e,n,t),moveTemplate:t=>()=>{(async(e,t,n)=>{const a=await ye(e)(),r=await ve(e)(n);G(r,a)||e.windowManager.open({title:"Move to",body:{type:"panel",items:[{type:"listbox",name:"category",label:"Category",items:Fe(a,ze(n,a))}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onSubmit:a=>{const{category:r}=a.getData();ge(e)(n,Ve(r)).then((async()=>{await t(),a.close()})).catch(qe(e))}})})(e,n,t)},moveCategoryItems:t=>()=>{(async(e,t,n)=>{const a=await ye(e)(),r=((e,t)=>{const n=D(t,(t=>t.id===e)).getOrDie();if(q(n))return n;throw new Error(JSON.stringify(n)+" is not a category.")})(n,a);H(r)||e.windowManager.open({title:"Move all items",body:{type:"panel",items:[{type:"listbox",name:"category",label:"Category",items:Fe(a,n)}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onSubmit:a=>{const{category:r}=a.getData();me(e)(n,Ve(r)).then((async()=>{await t(),a.close()})).catch(qe(e))}})})(e,n,t)},deleteTemplate:a=>()=>{e.windowManager.confirm("Are you sure you want to permanently delete the template?",(r=>{r&&he(e)(a).then((async()=>{t.get().exists((e=>e===a))?(t.clear(),await n(!0)):await n(!1)})).catch(qe(e))}))},deleteCategory:t=>()=>{e.windowManager.confirm("Are you sure you want to permanently delete the category and all its content?",(a=>{a&&de(e)(t).then((async()=>{await n()})).catch(qe(e))}))}}),Ct=async e=>{let t=!1;const n=(()=>{const e=(e=>{const t=g(b.none()),n=()=>t.get().each(e);return{clear:()=>{n(),t.set(b.none())},isSet:()=>t.get().isSome(),get:()=>t.get(),set:e=>{n(),t.set(b.some(e))}}})(v);return{...e,on:t=>e.get().each(t)}})();let a=[];const r=a=>{ve(e)(a).then((r=>{m.setData({preview:bt(e,r.content)}),n.set(a),t||(t=!0,m.setEnabled("submit",!0))}))},o=(e,t)=>{if(0===t.length)return e;{const n=t.toLowerCase(),a=(e=>{const t=x.call(e,0);return t.sort(((e,t)=>e.index-t.index)),t})(P(Ke(e),(e=>{const t=e.title.toLowerCase().indexOf(n);return t>=0?[{item:e,index:t}]:[]})));return A(a,(({item:e})=>e))}},i=(s,c)=>({title:"Templates",size:"large",onChange:()=>{const e=m.getData();m.redial(i(s,e))},onAction:(t,n)=>{"addcategory"===n.name&&((e,t)=>{e.windowManager.open({title:"New category",body:{type:"panel",items:[{type:"input",name:"title",label:"Category name"}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,enabled:!1}],onChange:e=>{const t=e.getData();e.setEnabled("save",t.title.length>0)},onSubmit:n=>{const{title:a}=n.getData();le(e)(a).then((async()=>{await t(),n.close()})).catch(qe(e))}})})(e,l)},initialData:c,body:{type:"panel",classes:["tox-advtemplate"],items:[{type:"grid",columns:2,items:[{type:"panel",items:[{type:"input",name:"search",placeholder:"Search"},{type:"tree",items:o(s,c.search),onLeafAction:r,onToggleExpand:e=>{a=e},defaultExpandedIds:c.search.length>0?[]:a,...n.get().fold((()=>({})),(e=>({defaultSelectedId:e})))}]},{type:"iframe",name:"preview",sandboxed:!1,transparent:!1}]}]},buttons:[...Ue(e,"advtemplate_create_category",{type:"custom",name:"addcategory",text:"New category",align:"start"}),{type:"cancel",name:"cancel",text:"Cancel"},{enabled:t,type:"submit",name:"submit",text:"Insert",primary:!0}],onSubmit:t=>{n.get().each((n=>{je(e,n).then(t.close).catch(qe(e))}))}}),s=async t=>{const n=await ye(e)();return We(null,n,t,e)},l=async(t=!1)=>{const n=await s(c),a=m.getData();t&&(a.preview=xt(e)),m.redial(i(n,a))},c=St(e,n,l),m=e.windowManager.open(i(await s(c),{preview:xt(e),search:""}))},Ot=(e,t,n)=>m(n)?e.execCommand(t):e.execCommand(t,!1,n);tinymce.PluginManager.requireLangPack("advtemplate","ar,bg_BG,ca,cs,da,de,el,es,eu,fa,fi,fr_FR,he_IL,hi,hr,hu_HU,id,it,ja,kk,ko_KR,ms,nb_NO,nl,pl,pt_BR,pt_PT,ro,ru,sk,sl_SI,sv_SE,th_TH,tr,uk,vi,zh_CN,zh_TW"),tinymce.PluginManager.add("advtemplate",(e=>{((e,n)=>!!e&&-1===((e,n)=>{const a=t(e.major,n.major);if(0!==a)return a;const r=t(e.minor,n.minor);if(0!==r)return r;const o=t(e.patch,n.patch);return 0!==o?o:0})((e=>a((e=>[e.majorVersion,e.minorVersion].join(".").split(".").slice(0,3).join("."))(e)))(e),a(n)))(tinymce,"6.5.0")?console.error("The advtemplate plugin requires at least version 6.5.0 of TinyMCE."):(se(e),(e=>{b.from(fe(e)).each((t=>{const n=((e=[])=>{let t=[];const n={},a={};let r=0;const o=()=>(++r).toString(),s=e=>e.bind(l).exists(H),l=e=>b.from(a[e]),c=e=>l(e).getOrDie("Category not found"),m=e=>e.bind(l).fold((()=>t),(e=>e.items)),d=(e,t)=>{if(!(i(t)&&(n=Ze(t),n.length>0)))throw new Error("Invalid title");var n;if((e=>{for(let n=0,a=e.length;n<a;n++)if(e[n].title===t)return!0;return!1})(e))throw new Error("The name already exists")},p=e=>b.from(n[e]).getOrDie("Template not found"),u=(e,n)=>{d(t,e);const r=o(),i={id:r,title:e,items:[],locked:n||!1};return t.push(i),a[r]=i,{...i}},g=(e,t,a)=>{const r=m(b.from(a));d(r,e);const i=o(),s={id:i,title:e,content:t};return r.push(s),n[i]={template:s,parent:b.from(a)},{...s}},v=(e,t)=>{const n=m(t);k(n,(t=>t.id===e)).each((e=>n.splice(e,1)))},h=async(e,t)=>{const{template:a,parent:r}=p(e),o=b.from(t);return s(r)||s(o)||(m(o).push(a),v(e,r),n[e]={template:a,parent:o}),Promise.resolve({})},y=(e,t)=>{for(const n of e)if(X(n)){const e=u(n.title,n.locked);y(n.items,e.id)}else g(n.title,n.content,t)};return y(e),{advtemplate_create_category:async e=>{const{id:t}=u(e);return Promise.resolve({id:t})},advtemplate_rename_category:async(e,n)=>{const a=c(e);return a.title===n||H(a)||(d(t,n),a.title=n),Promise.resolve({})},advtemplate_delete_category:async e=>{const n=c(e);return H(n)||((t=>{for(let a=t.length-1;a>=0;a--)n=t[a],v(n.id,b.from(e));var n})(n.items),k(t,(t=>t.id===e)).each((e=>t.splice(e,1))),delete a[e]),Promise.resolve({})},advtemplate_create_template:async(e,t,n)=>{s(b.from(n))&&(n=void 0);const{id:a}=g(e,t,n);return Promise.resolve({id:a})},advtemplate_rename_template:async(e,t)=>{const{template:n,parent:a}=p(e);if(s(a))return Promise.resolve({});if(n.title===t)return Promise.resolve({});const r=m(a);return d(r,t),n.title=t,Promise.resolve({})},advtemplate_update_template:async(e,t)=>{const{template:n,parent:a}=p(e);return s(a)||(n.content=t),Promise.resolve({})},advtemplate_move_template:h,advtemplate_get_template:async e=>{const{template:t}=p(e);return Promise.resolve({...t})},advtemplate_delete_template:async e=>{const{parent:t}=p(e);return s(t)||(v(e,t),delete n[e]),Promise.resolve({})},advtemplate_list:async(e=!1)=>{if(e)return Promise.resolve([...t]);{const e=A(t,(e=>q(e)?{id:e.id,title:e.title,locked:e.locked,items:A(e.items,(({id:e,title:t})=>({id:e,title:t})))}:{id:e.id,title:e.title}));return Promise.resolve(e)}},advtemplate_delete_all:async()=>(t=T(t,(e=>q(e)?H(e):G(e,t))),B(n,((e,t)=>{e.parent.exists((e=>l(e).exists(H)))||delete n[t]})),B(a,((e,t)=>{H(e)||delete a[t]})),Promise.resolve({})),advtemplate_move_category_items:async(e,t)=>{const n=b.from(e);if(s(n)||s(b.from(t)))return Promise.resolve({});const a=m(n).slice();for(let e=0;e<a.length;e++){const n=(r=a,(o=e)>=0&&o<r.length?b.some(r[o]):b.none());await h(n.getOrDie().id,t)}var r,o;return Promise.resolve({})}}})(t);B(n,((t,n)=>{O(["advtemplate_list","advtemplate_get_template"],n)?e.options.set(n,t):e.options.unset(n)}))}))})(e),(e=>{const t=(t,n)=>{e.addCommand(t,n)};t("AdvTemplateInsertDialog",(()=>{Ct(e)})),e.options.isSet("advtemplate_create_template")&&t("AdvTemplateAddDialog",(()=>{(async e=>{const t=await ye(e)();e.windowManager.open({title:"New template",body:{type:"panel",items:[{type:"input",name:"title",label:"Template name"},{type:"listbox",name:"category",label:"Category",items:Fe(t)}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,enabled:!1}],onChange:e=>{const t=e.getData();e.setEnabled("save",t.title.length>0)},onSubmit:t=>{const{title:n,category:a}=t.getData();pe(e)(n,e.selection.getContent(),Ve(a)).then((()=>{t.close(),e.notificationManager.open({text:"Template successfully saved",type:"success",timeout:2e3})})).catch(qe(e))}})})(e)})),t("AdvTemplateInsertTemplateById",((t,n)=>{if(!V(n))throw new Error("Id should be non-empty string");je(e,n).catch((e=>{console.error("Insert template by id failed due to:",e)}))}))})(e),(e=>{e.options.isSet("advtemplate_create_template")&&e.ui.registry.addButton("addtemplate",{tooltip:"Save as template",icon:"template-add",onAction:()=>{Ot(e,"AdvTemplateAddDialog")},onSetup:t=>{t.setEnabled(!1);const n=()=>{t.setEnabled(!e.selection.isCollapsed()&&!e.mode.isReadOnly())};return e.on("NodeChange SelectionChange",n),()=>{e.off("NodeChange SelectionChange",n)}}}),e.ui.registry.addButton("inserttemplate",{tooltip:"Insert template",icon:"template",onSetup:t=>{const n=()=>{t.setEnabled(e.selection.isEditable())};return e.on("NodeChange",n),n(),()=>{e.off("NodeChange",n)}},onAction:()=>{Ot(e,"AdvTemplateInsertDialog")}})})(e),(e=>{e.ui.registry.addMenuItem("inserttemplate",{text:"Template...",icon:"template",onSetup:t=>(t.setEnabled(e.selection.isEditable()),v),onAction:()=>Ot(e,"AdvTemplateInsertDialog")}),e.options.isSet("advtemplate_create_template")&&e.ui.registry.addMenuItem("addtemplate",{text:"Save as template...",icon:"template-add",onAction:()=>e.execCommand("AdvTemplateAddDialog"),onSetup:t=>(t.setEnabled(!e.selection.isCollapsed()),v)}),e.ui.registry.addContextMenu("advtemplate",{update:h("addtemplate")})})(e))}))}();