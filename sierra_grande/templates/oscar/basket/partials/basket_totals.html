{% load i18n %}
{% load currency_filters %}
{% load shipping_tags %}

<div id="basket_totals">
  <table class="table table-sm align-middle">
    <tbody>
      {% block basket_header %}
        <tr>
          <th colspan="2">
            <h3>{% translate "Basket" %}</h3>
          </th>
        </tr>
      {% endblock basket_header %}
      {% with offer_discounts=basket.offer_discounts voucher_discounts=basket.grouped_voucher_discounts %}
        {% block discount_totals %}
          {% if offer_discounts or voucher_discounts %}
            {# Basket total will be discounted so we show a before and after version #}
            <tr>
              <td>{% translate "Basket total (before discounts)" %}</td>
              <td class="text-end">
                {% if basket.is_tax_known and not show_tax_separately %}
                  {{ basket.total_incl_tax_excl_discounts|currency:basket.currency }}
                {% else %}
                  {{ basket.total_excl_tax_excl_discounts|currency:basket.currency }}
                {% endif %}
              </td>
            </tr>
            {% for discount in offer_discounts %}
              <tr>
                <td class="basket-discount">
                  <span class="badge bg-success">{% translate "Discount" %}</span> {{ discount.name }}
                  {% if discount.description %}
                    <br />
                    <small>{{ discount.description }}</small>
                  {% endif %}
                </td>
                <td class="text-end">-{{ discount.discount|currency:basket.currency }}</td>
              </tr>
            {% endfor %}
            {% if voucher_discounts %}
              <tr>
                <th colspan="2">
                  <h3>{% translate "Vouchers" %}</h3>
                </th>
              </tr>
              {% for discount in voucher_discounts %}
                <tr>
                  <td>
                    {% if discount.voucher.voucher_set %}
                      {{ discount.voucher.voucher_set.name }} ({{ discount.voucher.code }})
                    {% else %}
                      {{ discount.voucher.name }} ({{ discount.voucher.code }})
                    {% endif %}
                    {% if editable %}
                      <form action="{% url 'basket:vouchers-remove' pk=discount.voucher.id %}"
                            method="post">
                        {% csrf_token %}
                        <input type="submit"
                               value="{% translate "Remove" %}"
                               class="btn btn-sm btn-danger" />
                      </form>
                    {% endif %}
                  </td>
                  <td class="text-end">-{{ discount.discount|currency:basket.currency }}</td>
                </tr>
              {% endfor %}
            {% endif %}
          {% endif %}
        {% endblock discount_totals %}
        {% block basket_total %}
          {% if offer_discounts or voucher_discounts %}
            <tr>
              <th class="total">{% translate "Basket total (after discounts)" %}</th>
              <th class="total text-end">
                {% if not show_tax_separately and basket.is_tax_known %}
                  {{ basket.total_incl_tax|currency:basket.currency }}
                {% else %}
                  {{ basket.total_excl_tax|currency:basket.currency }}
                {% endif %}
              </th>
            </tr>
          {% else %}
            {# No discounts to basket #}
            <tr>
              <th class="total">{% translate "Basket total" %}</th>
              <th class="total text-end">
                {% if not show_tax_separately and basket.is_tax_known %}
                  {{ basket.total_incl_tax|currency:basket.currency }}
                {% else %}
                  {{ basket.total_excl_tax|currency:basket.currency }}
                {% endif %}
              </th>
            </tr>
          {% endif %}
        {% endblock basket_total %}
      {% endwith %}
      {% block shipping_totals %}
        <tr>
          <th>&nbsp;</th>
          <td></td>
        </tr>
        <tr>
          <th colspan="2">
            <h3>{% translate "Shipping" %}</h3>
            {% if shipping_methods|length > 1 and editable %}
              <small>{% translate "Alternative shipping methods can be chosen during checkout" %}</small>
            {% endif %}
          </th>
        </tr>
        {% if not shipping_method.is_discounted %}
          <tr>
            <th class="total">{{ shipping_method.name }}</th>
            <th class="total text-end">
              {% if not show_tax_separately and shipping_charge.is_tax_known %}
                {{ shipping_charge.incl_tax|currency:basket.currency }}
              {% else %}
                {{ shipping_charge.excl_tax|currency:basket.currency }}
              {% endif %}
            </th>
          </tr>
        {% else %}
          {% shipping_charge_discount shipping_method basket as shipping_discount %}
          {% shipping_charge_excl_discount shipping_method basket as shipping_charge_excl_discount %}
          {# As shipping is discounted, we break it down into its original charge and a discount #}
          <tr>
            <th class="total">{% translate "Shipping method" %}</th>
            <td class="total text-end">{{ shipping_method.name }}</td>
          </tr>
          <tr>
            <td>{% translate "Shipping total (before discounts)" %}</td>
            <td class="text-end">
              {% if not show_tax_separately and shipping_charge_excl_discount.is_tax_known %}
                {{ shipping_charge_excl_discount.incl_tax|currency:basket.currency }}
              {% else %}
                {{ shipping_charge_excl_discount.excl_tax|currency:basket.currency }}
              {% endif %}
            </td>
          </tr>
          {# This section needs adjustment to when taxes are shown separately #}
          <tr>
            <td class="basket-discount">
              <span class="badge bg-success">{% translate "Discount" %}</span> {{ shipping_method.discount_name }}
            </td>
            <td class="text-end">-{{ shipping_discount|currency:basket.currency }}</td>
          </tr>
          <tr>
            <th class="total">{% translate "Shipping total (after discounts)" %}</th>
            <th class="total text-end">
              {% if not show_tax_separately and shipping_charge.is_tax_known %}
                {{ shipping_charge.incl_tax|currency:basket.currency }}
              {% else %}
                {{ shipping_charge.excl_tax|currency:basket.currency }}
              {% endif %}
            </th>
          </tr>
        {% endif %}
      {% endblock shipping_totals %}
      {% block surcharges %}
        {% if surcharges %}
          <tr>
            <th>&nbsp;</th>
            <td></td>
          </tr>
          <tr>
            <th colspan="2">
              <h3>{% translate "Surcharges" %}</h3>
            </th>
          </tr>
          {% for surcharge in surcharges %}
            <tr>
              <th class="total">{{ surcharge.surcharge.name }}</th>
              <th class="total align-right">
                {% if not show_tax_separately and surcharge.price.is_tax_known %}
                  {{ surcharge.price.incl_tax|currency:basket.currency }}
                {% else %}
                  {{ surcharge.price.excl_tax|currency:basket.currency }}
                {% endif %}
              </th>
            </tr>
          {% endfor %}
        {% endif %}
      {% endblock surcharges %}
      {% block tax_totals %}
        {% if show_tax_separately %}
          <tr>
            <th>&nbsp;</th>
            <td></td>
          </tr>
          <tr>
            <th colspan="2">
              <h3>{% translate "Tax" %}</h3>
            </th>
          </tr>
          <tr>
            <th class="total">{% translate "Basket" %}</th>
            <th class="total text-end">{{ basket.total_tax|currency:basket.currency }}</th>
          </tr>
          <tr>
            <th class="total">{% translate "Shipping" %}</th>
            <th class="total text-end">{{ shipping_charge.tax|currency:basket.currency }}</th>
          </tr>
        {% endif %}
      {% endblock tax_totals %}
      {% block post_order_action_totals %}
        {% if basket.post_order_actions %}
          <tr>
            <th>&nbsp;</th>
            <td></td>
          </tr>
          <tr>
            <th>
              <h3>{% translate "Post order actions" %}</h3>
              <small>{% translate "These will be applied once your order is placed." %}</small>
            </th>
            <td></td>
          </tr>
          {% for discount in basket.post_order_actions %}
            <tr>
              <td class="total" colspan="2">
                <span class="badge bg-success">{{ discount.name }}</span>
                <br />
                <p>{{ discount.description }}</p>
              </td>
            </tr>
          {% endfor %}
        {% endif %}
      {% endblock post_order_action_totals %}
      {% block order_total %}
        <tr>
          <th>&nbsp;</th>
          <td></td>
        </tr>
        <tr>
          <th class="total">
            <h3>{% translate "Order total" %}</h3>
          </th>
          <td class="total text-end">
            <h3 class="price_color">
              {% if order_total.is_tax_known %}
                {{ order_total.incl_tax|currency:basket.currency }}
              {% else %}
                {{ order_total.excl_tax|currency:basket.currency }}
              {% endif %}
            </h3>
          </td>
        </tr>
        {% if not order_total.is_tax_known %}
          <tr>
            <td>
              <small>{% translate "Taxes will be added during checkout." %}</small>
            </td>
          </tr>
        {% endif %}
      {% endblock order_total %}
    </tbody>
  </table>
</div>
