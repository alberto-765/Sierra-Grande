{% extends "oscar/dashboard/layout.html" %}

{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}


{% block extrastyles %}
  {{ block.super }}
  <link rel="stylesheet" type="text/x-scss" href="{% static "scss/dashboard/product.scss" %}" />
{% endblock extrastyles %}

{% block extrahead %}
  {{ block.super }}
  {{ form.media }}
{% endblock extrahead %}

{% block body_class %}
  {{ block.super }} create-page catalogue
{% endblock body_class %}

{% block title %}
  {{ title }} | {% translate "Products" %} | {{ block.super }}
{% endblock title %}

{% block breadcrumbs %}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url "dashboard:index" %}">{% translate "Dashboard" %}</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url "dashboard:catalogue-product-list" %}">{% translate "Products" %}</a>
      </li>
      {% if parent %}
        <li class="breadcrumb-item">
          <a href="{% url "dashboard:catalogue-product" parent.id %}">{{ parent.title }}</a>
        </li>
      {% endif %}
      <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
    </ol>
  </nav>
{% endblock breadcrumbs %}
{% block main_header_content %}
  {{ title }}
{% endblock main_header_content %}
{% block dashboard_content %}
  <form action="{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}"
        method="post"
        class="vertical-navs-step form-steps"
        enctype="multipart/form-data"
        data-behaviour="tab-nav-errors"
        autocomplete="off">
    {% csrf_token %}
    {% if parent %}
      <div class="row">
        <div class="col-md-12">
          <div class="alert alert-info mb-0">
            {% url "dashboard:catalogue-product" pk=parent.id as parent_url %}
            {% blocktranslate with title=parent.title %}
                You are currently editing a product variant of
                <a href="{{ parent_url }}">{{ title }}</a>.
            {% endblocktranslate %}
          </div>
        </div>
      </div>
    {% endif %}

    <div class="row gy-5">
      {% block tab_nav %}
        <div class="col-lg-3">
            <div class="nav flex-column custom-nav nav-pills" role="tablist" aria-orientation="vertical">
              {% block tabs %}
                <a class="nav-link active"
                  href="#product_details" aria-controls="product_details" id="product_details_tab"
                  data-bs-toggle="pill" role="tab" aria-selected="true">
                  <i class="step-icon"></i>
                  {% translate "Product details" %}
                </a>
                {% if not parent %}
                  <a class="nav-link"
                    href="#product_category" aria-controls="product_category" id="product_category_tab"
                    data-bs-toggle="pill" role="tab" aria-selected="false">
                    <i class="step-icon"></i>
                    {% translate "Categories" %}
                  </a>
                {% endif %}
                {% if product_class.has_attributes %}
                  <a class="nav-link"
                    href="#product_attributes" aria-controls="product_attributes" id="product_attributes_tab"
                    data-bs-toggle="pill" role="tab" aria-selected="false">
                    <i class="step-icon"></i>
                    {% translate "Attributes" %}
                  </a>
                {% endif %}
                <a class="nav-link"
                  href="#product_images" aria-controls="product_images" id="product_images_tab"
                  data-bs-toggle="pill" role="tab" aria-selected="false">
                  <i class="step-icon"></i>
                  {% translate "Images" %}
                </a>
                {% if not product.is_parent %}
                  <a class="nav-link"
                    href="#product_stock" aria-controls="product_stock" id="product_stock_tab"
                    data-bs-toggle="pill" role="tab" aria-selected="false">
                    <i class="step-icon"></i>
                    {% translate "Stock and pricing" %}
                  </a>
                {% endif %}
                {% if user.is_staff and not parent %}
                  <a class="nav-link"
                    href="#child_products" aria-controls="child_products" id="child_products_tab"
                    data-bs-toggle="pill" role="tab" aria-selected="false">
                    <i class="step-icon"></i>
                    {% translate "Variants" %}
                  </a>
                {% endif %}
                {% if not parent %}
                  <a class="nav-link"
                    href="#product_recommended" aria-controls="product_recommended" id="product_recommended_tab"
                    data-bs-toggle="pill" role="tab" aria-selected="false">
                    <i class="step-icon"></i>
                    {% translate "Upselling" %}
                  </a>
                {% endif %}
                <a class="nav-link"
                  href="#seo" aria-controls="seo" id="seo_tab"
                  data-bs-toggle="pill" role="tab" aria-selected="false">
                  <i class="step-icon"></i>
                  {% translate "Search engine optimisation" %}
                </a>
              {% endblock tabs %}
            </div>
        </div> 
      {% endblock tab_nav %}

      <div class="col-lg-9">
          <div class="card card-body px-lg-4">
            <div class="tab-content">
              {% block tab_content %}
                {% block product_details %}
                  <div class="tab-pane fade show active" id="product_details" role="tabpanel" aria-labelledby="product_details_tab">
                    <div>
                      <h5>{% translate "Product details" %}</h5>
                      <p class="text-muted">{% translate 'Fill all fields with *' %}</p>
                    </div>
                    <div class="tab-pane--details">
                      {% block product_details_content %}
                        {% if form.non_field_errors %}<span class="text-danger">{{ form.non_field_errors }}</span>{% endif %}
                        {% for field in form.primary_form_fields %}
                          {% if forloop.last %}
                            {% include "oscar/dashboard/partials/form_field.html" with field=field %}
                          {% else %}
                            {% include "oscar/dashboard/partials/form_field.html" with field=field margin="true" %}
                          {% endif %}
                        {% endfor %}
                      {% endblock product_details_content %}
                    </div>
                  </div>
                {% endblock product_details %}
                {% block product_categories %}
                  <div class="tab-pane fade" id="product_category" role="tabpanel" aria-labelledby="product_category_tab">
                    {% block product_categories_content %}
                      <div>
                        <h5>{% translate "Category" %}</h5>
                        <p class="text-muted">{% translate 'Fill all fields with *' %}</p>
                      </div>
                    <div class="tab-pane--categories">
                      {{ category_formset.management_form }}
                      {% if category_formset.non_form_errors %}
                        <div class="alert alert-danger">
                          {{ category_formset.non_form_errors }}
                        </div>
                      {% endif %}
                      {% for category_form in category_formset %}
                        {% crispy category_form %}
                      {% endfor %}
                    </div>
                  {% endblock product_categories_content %}
                </div>
              {% endblock product_categories %}
                {% block product_attributes %}
                  {% if product_class.has_attributes %}
                    <div class="tab-pane fade" id="product_attributes" role="tabpanel" aria-labelledby="product_attributes_tab">
                      <div>
                        <h5 class="hstack column-gap-2 align-items-center">
                          {% translate "Attributes" %}
                          <span class="badge text-bg-success">{% translate "Product Type:" %} {{ product_class }}</span>
                        </h5>
                        <p class="text-muted">{% translate 'Fill all fields with *' %}</p>
                      </div>
                      <div class="tab-pane--details">
                        {% block product_attributes_content %}
                          {% for field in form.attr_form_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% endblock product_attributes_content %}
                      </div>
                    </div>
                  {% endif %}
                {% endblock product_attributes %}
                {% block product_images %}
                  <div class="tab-pane fade" id="product_images" role="tabpanel" aria-labelledby="product_images_tab">
                    <div>
                        <h5>{% translate "Upload, change or remove images" %}</h5>
                        <p class="text-muted">{% translate 'Use WebP images for better performance' %}</p>
                    </div>
                    <div>
                      {% block product_images_content %}
                        {{ image_formset.management_form }}
                        {% if image_formset.non_form_errors %}
                          <div class="alert alert-danger">
                            {{ image_formset.non_form_errors }}
                          </div>
                        {% endif %}
                        <div class="row g-4 upload-image">
                          {% for image_form in image_formset %}
                            <div class="col-sm-6 sortable-handle p-2'">
                              {% include "oscar/dashboard/partials/product_images.html" with form=image_form %}
                            </div>
                          {% endfor %}
                        </div>
                        
                        <div class="mt-3 mb-0 alert alert-light icon-link">
                          <iconify-icon icon="ic:round-info" width="1.2rem" height="1.2rem"></iconify-icon>
                          {% translate "Drag images to re-order them. Space for additional images will appear when images are added." %}
                        </div>
                      {% endblock product_images_content %}
                    </div>
                  </div>
                {% endblock product_images %}
                {% block stockrecords %}
                  <div class="tab-pane fade" id="product_stock" role="tabpanel" aria-labelledby="product_stock_tab">
                    {% block stockrecords_content %}
                      <div>
                          <h5>{% translate "Stock and pricing" %}</h5>
                          <p class="text-muted">{% translate 'Fill all fields with *' %}</p>
                      </div>
                      <div class="table-responsive-xl">
                        {% if stockrecord_formset.non_form_errors %}
                          <div class="alert alert-danger">
                            {{ stockrecord_formset.non_form_errors }}
                          </div>
                        {% endif %}
                        <table class="table table-striped table-bordered align-middle mb-0">
                          {{ stockrecord_formset.management_form }}
                          <thead>
                            <tr>
                              <td scope="col">{% translate "Partner*" %}</td>
                              <td scope="col">{% translate "SKU*" %}</td>
                              {% if product_class.track_stock %}
                                <td scope="col">{% translate "Num in stock*" %}</td>
                                <td scope="col">{% translate "Num allocated" %}</td>
                                <td scope="col">{% translate "Low stock threshold" %}</td>
                              {% endif %}
                              <td scope="col">{% translate "Currency*" %}</td>
                              <td scope="col">{% translate "Price*" %}</td>
                              <td scope="col">{% translate "Delete?" %}</td>
                            </tr>
                          </thead>
                          <tbody>
                            {% for stockrecord_form in stockrecord_formset %}
                              {% if stockrecord_form.non_field_errors %}
                                <tr>
                                  <td colspan="{% if product_class.track_stock %}10{% else %}7{% endif %}">
                                    {% for error in stockrecord_form.non_field_errors %}
                                      <span class="text-danger errorlist">
                                        <iconify-icon icon="fa:exclamation-triangle" width="1rem" height="1rem" aria-hidden="true"></iconify-icon>
                                        {{ error }}
                                      </span>
                                    {% endfor %}
                                  </td>
                                </tr>
                              {% endif %}
                              <tr>
                                <td>{% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.partner nolabel=True form_show_errors=True %}</td>
                                <td>{% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.partner_sku nolabel=True form_show_errors=True %}</td>
                                {% if product_class.track_stock %}
                                  <td>
                                    {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.num_in_stock nolabel=True form_show_errors=True %}
                                  </td>
                                  <td>{{ stockrecord_form.instance.num_allocated|default:"-" }}</td>
                                  <td>
                                    {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.low_stock_threshold nolabel=True form_show_errors=True %}
                                  </td>
                                {% endif %}
                                <td>
                                  {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.price_currency nolabel=True form_show_errors=True %}
                                </td>
                                <td>{% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.price nolabel=True form_show_errors=True %}</td>
                                <td>
                                  {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.id nolabel=True form_show_errors=True %}
                                  {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.DELETE nolabel=True form_show_errors=True %}
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody> 
                        </table>
                      </div>
                    {% endblock stockrecords_content %}
                  </div>
                {% endblock stockrecords %}
                {% block child_products %}
                  {% with children=product.children.all %}
                    <div class="tab-pane fade vstack row-gap-2" id="child_products" role="tabpanel" aria-labelledby="child_products_tab">
                      <div class="vstack row-gap-3"> 
                        {% block child_products_content %}
                          <div class="hstack justify-content-between align-item s-center">
                              <h5 class="mb-0">{% translate "Variants" %}</h5>
                              <button class="btn btn-primary icon-link"
                                        {% if not product.can_be_parent %}disabled{% endif %}
                                        name="action"
                                        type="submit"
                                        value="create-child"
                                        data-loading-text="{% translate "Adding..." %}">
                                  <iconify-icon icon="mdi:plus-circle" width="1rem" height="1rem" aria-hidden="true"></iconify-icon> {% translate "Add variant" %}
                              </button>
                          </div>
                          {% if children %}
                            <div class="table-responsive">
                              <table class="table table-striped table-bordered align-middle mb-0">
                                <tr>
                                  <th>{% translate "Title" %}</th>
                                  <th>{% translate "Attributes" %}</th>
                                  <th>{% translate "Stock records" %}</th>
                                  <th>{% translate "Is public?" %}</th>
                                  <th>&nbsp;</th>
                                </tr>
                                {% for child in children %}
                                  <tr>
                                    <td>{{ child.get_title }}</td>
                                    <td>{{ child.attribute_summary }}</td>
                                    <td>{{ child.stockrecords.count }}</td>
                                    <td>
                                      {% if child.is_public %}
                                        <span class="true">✔</span>
                                      {% else %}
                                        <span class="false">✘</span>
                                      {% endif %}
                                    </td>
                                    <td>
                                      <a href="{% url "dashboard:catalogue-product" pk=child.id %}"
                                        class="btn btn-primary">{% translate "Edit" %}</a>
                                      <a href="{% url "dashboard:catalogue-product-delete" pk=child.id %}"
                                        class="btn btn-danger">{% translate "Delete" %}</a>
                                    </td>
                                  </tr>
                                {% endfor %}
                              </table>
                            </div>
                          {% else %}
                            <div class="alert alert-warning alert-border-left show mb-0" role="alert">
                              <iconify-icon icon="si:alert-line" class="align-middle fs-20"></iconify-icon>
                              <span>
                                {% if product.can_be_parent %}
                                  {% translate "This product does not have any variants." %}
                                {% else %}
                                  {% translate "One can't add variants to this product at this point." %}
                                  {% if product.pk is None %}
                                    {% translate "Please save the product before trying to add variants." %}
                                  {% elif product.has_stockrecords %}
                                    {% translate "This is likely because this product still has stock records." %}
                                  {% endif %}
                                {% endif %}
                              </span>
                            </div>
                          {% endif %}
                        {% endblock child_products_content %}
                      </div>
                    </div>
                  {% endwith %}
                {% endblock child_products %}
                {% block recommended_products %}
                  <div class="tab-pane fade" id="product_recommended" role="tabpanel" aria-labelledby="product_recommended_tab">
                    {% block recommended_products_content %}
                      <div>
                          <h5>{% translate "Recommended products" %}</h5>
                          <p class="text-muted">{% translate 'Fill all fields with *' %}</p>
                      </div>
                      <div class="tab-pane--categories vstack row-gap-1">
                        {{ recommended_formset.management_form }}
                        {% if recommended_formset.non_form_errors %}
                          <div class="alert alert-danger">
                            {{ recommended_formset.non_form_errors }}
                          </div>
                        {% endif %}
                        {% for recommended_form in recommended_formset %}
                          {% crispy recommended_form %}
                        {% endfor %}
                      </div>
                    {% endblock recommended_products_content %}
                  </div>
                {% endblock recommended_products %}
                {% block seo %}
                  <div class="tab-pane fade" id="seo" role="tabpanel" aria-labelledby="seo_tab">
                     <div>
                        <h5>{% translate "Search engine optimisation" %}</h5>
                        <p class="text-muted">{% translate 'Fill all fields with *' %}</p>
                    </div>
                    <div class="tab-pane--details">
                      {% for field in form.seo_form_fields %}
                        {% if forloop.last %}
                          {% include "oscar/dashboard/partials/form_field.html" with field=field %}
                        {% else %}
                            {% include "oscar/dashboard/partials/form_field.html" with field=field margin="true" %}
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                {% endblock seo %}
              {% endblock tab_content %}
              </div>
          </div>
      </div>
    </div>

    {% block fixed_actions_group %}
      <div class="form-actions-fixed align-items-center bg-dark column-gap-4 fixed-bottom hstack justify-content-end p-3">
        {% if parent %}
          <a class="btn btn-danger" href="{% url "dashboard:catalogue-product-list" %}">
            {% translate "Cancel" %}
          </a>
          <button class="btn btn-outline-light"
                  name="action"
                  type="submit"
                  value="create-another-child"
                  data-loading-text="{% translate "Saving..." %}">
            {% translate "Save and add another variant" %}
          </button>
        {% endif %}
        <button class="btn btn-outline-light"
                name="action"
                type="submit"
                value="continue"
                data-loading-text="{% translate "Saving..." %}">{% translate "Save and continue editing" %}</button>
        <button class="btn btn-primary" name="action" type="submit" value="save" data-loading-text="{% translate "Saving..." %}">
          {% translate "Save" %}
        </button>
      </div>
    {% endblock fixed_actions_group %}
  </form>
{% endblock dashboard_content %}

{% block extrascripts %}
  {{ block.super }}
  <script src="{% static "js/components/form-wizard.init.js" %}" defer></script>
  <script src="{% static "libs/choices/choices.min.js" %}" defer></script>
  <script src="{% static "libs/sortable/sortable.min.js" %}" defer></script>
{% endblock extrascripts %}

{% block onbodyload %}
  {{ block.super }}
  oscar.dashboard.initProductImages();
{% endblock onbodyload %}
