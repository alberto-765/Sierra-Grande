{% extends "oscar/dashboard/layout.html" %}

{% load i18n %}
{% load crispy_forms_tags %}

{% block extrahead %}
  {{ block.super }}
  {{ form.media }}
{% endblock extrahead %}
{% block body_class %}
  {{ block.super }} create-page catalogue
{% endblock body_class %}
{% block title %}
  {{ title }} | {% translate "Products" %} | {{ block.super }}
{% endblock title %}
{% block breadcrumbs %}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url "dashboard:index" %}">{% translate "Dashboard" %}</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url "dashboard:catalogue-product-list" %}">{% translate "Products" %}</a>
      </li>
      {% if parent %}
        <li class="breadcrumb-item">
          <a href="{% url "dashboard:catalogue-product" parent.id %}">{{ parent.title }}</a>
        </li>
      {% endif %}
      <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
    </ol>
  </nav>
{% endblock breadcrumbs %}
{% block headertext %}
  {{ title }}
{% endblock headertext %}
{% block dashboard_content %}
  <form action="{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}"
        method="post"
        class="wysiwyg"
        enctype="multipart/form-data"
        data-behaviour="tab-nav-errors"
        autocomplete="off">
    {% csrf_token %}
    {% if parent %}
      <div class="row">
        <div class="col-md-12">
          <div class="alert alert-info mb-0">
            {% url "dashboard:catalogue-product" pk=parent.id as parent_url %}
            {% blocktranslate with title=parent.title %}
                You are currently editing a product variant of
                <a href="{{ parent_url }}">{{ title }}</a>.
            {% endblocktranslate %}
          </div>
        </div>
      </div>
    {% endif %}
    <div class="row g-4">
      {% block tab_nav %}
        <div class="col-md-3">
          <div class="card tab-nav">
            <div class="card-header">{% translate "Sections" %}</div>
            <div class="card-body p-0">
              <div class="list-group list-group-custom list-group-flush">
                {% comment %}
                                  The navigation below is filtered heavily on the product structure.
                                  This intentionally is the only place where filtering is done, as
                                  deployments are likely to want to override certain aspects of what
                                  data is stored on products of a certain structure. This means that
                                  only one template block (instead of all affected) has to be altered.
                {% endcomment %}
                {% block tabs %}
                  <a class="list-group-item list-group-item-action active"
                     href="#product_details"
                     data-bs-toggle="tab">{% translate "Product details" %}</a>
                  {% if not parent %}
                    <a class="list-group-item list-group-item-action"
                       href="#product_category"
                       data-bs-toggle="tab">{% translate "Categories" %}</a>
                  {% endif %}
                  {% if product_class.has_attributes %}
                    <a class="list-group-item list-group-item-action"
                       href="#product_attributes"
                       data-bs-toggle="tab">{% translate "Attributes" %}</a>
                  {% endif %}
                  <a class="list-group-item list-group-item-action"
                     href="#product_images"
                     data-bs-toggle="tab">{% translate "Images" %}</a>
                  {% if not product.is_parent %}
                    <a class="list-group-item list-group-item-action"
                       href="#product_stock"
                       data-bs-toggle="tab">{% translate "Stock and pricing" %}</a>
                  {% endif %}
                  {% if user.is_staff and not parent %}
                    <a class="list-group-item list-group-item-action"
                       href="#child_products"
                       data-bs-toggle="tab">{% translate "Variants" %}</a>
                  {% endif %}
                  {% if not parent %}
                    <a class="list-group-item list-group-item-action"
                       href="#product_recommended"
                       data-bs-toggle="tab">{% translate "Upselling" %}</a>
                  {% endif %}
                  <a class="list-group-item list-group-item-action"
                     href="#seo"
                     data-bs-toggle="tab">{% translate "Search engine optimisation" %}</a>
                {% endblock tabs %}
              </div>
            </div>
          </div>
        </div>
      {% endblock tab_nav %}
      <div class="col-md-9">
        <div class="tab-content">
          {% block tab_content %}
            {% block product_details %}
              <div class="card tab-pane active" id="product_details">
                <div class="card-header">{% translate "Product details" %}</div>
                <div class="card-body">
                  {% block product_details_content %}
                    {% if form.non_field_errors %}<span class="text-danger">{{ form.non_field_errors }}</span>{% endif %}
                    {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    {% for field in form.primary_form_fields %}{{ field|as_crispy_field }}{% endfor %}
                  {% endblock product_details_content %}
                </div>
              </div>
            {% endblock product_details %}
            {% block product_categories %}
              <div class="card tab-pane" id="product_category">
                {% block product_categories_content %}
                  <div class="card-header">{% translate "Category" %}</div>
                  <div class="card-body">
                    {{ category_formset.management_form }}
                    {% for category_form in category_formset %}
                      {% crispy category_form %}
                    {% endfor %}
                  </div>
                {% endblock product_categories_content %}
              </div>
            {% endblock product_categories %}
            {% block product_attributes %}
              {% if product_class.has_attributes %}
                <div class="card tab-pane" id="product_attributes">
                  <div class="card-header hstack column-gap-2 align-items-center">
                    {% translate "Attributes" %}
                    <span class="badge text-bg-success">{% translate "Product Type:" %} {{ product_class }}</span>
                  </div>
                  <div class="card-body">
                    {% block product_attributes_content %}
                      {% for field in form.attr_form_fields %}{{ field|as_crispy_field }}{% endfor %}
                    {% endblock product_attributes_content %}
                  </div>
                </div>
              {% endif %}
            {% endblock product_attributes %}
            {% block product_images %}
              <div class="card tab-pane" id="product_images">
                <div class="card-header">{% translate "Upload, change or remove images" %}</div>
                <div class="card-body">
                  {% block product_images_content %}
                    {{ image_formset.management_form }}
                    <div class="row row-gap-5">
                      {% for image_form in image_formset %}
                        {% crispy image_form %}
                      {% endfor %}
                    </div>
                    {% comment %} {{ image_formset.non_form_errors }}
                    <div class="upload-image row">
                      {% for image_form in image_formset %}
                        {% include "oscar/dashboard/partials/product_images.html" with form=image_form %}
                      {% endfor %}
                    </div> {% endcomment %}
                    <div class="mt-3 alert alert-info icon-link">
                      <iconify-icon icon="ic:round-info" width="1.2rem" height="1.2rem"></iconify-icon>
                      {% translate "Drag images to re-order them. Space for additional images will appear when images are added." %}
                    </div>
                  </div>
                {% endblock product_images_content %}
              </div>
            {% endblock product_images %}
            {% block stockrecords %}
              <div class="card tab-pane" id="product_stock">
                {% block stockrecords_content %}
                  <table class="table table-striped table-bordered align-middle">
                    <caption>{% translate "Stock and pricing" %}</caption>
                    {{ stockrecord_formset.management_form }}
                    {{ stockrecord_formset.non_form_errors }}
                    <thead>
                      <tr>
                        <th>{% translate "Partner" %}</th>
                        <th>{% translate "SKU" %}</th>
                        {% if product_class.track_stock %}
                          <th>{% translate "Num in stock" %}</th>
                          <th>{% translate "Num allocated" %}</th>
                          <th>{% translate "Low stock threshold" %}</th>
                        {% endif %}
                        <th>{% translate "Currency" %}</th>
                        <th>{% translate "Price" %}</th>
                        <th>{% translate "Delete?" %}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for stockrecord_form in stockrecord_formset %}
                        {% if stockrecord_form.non_field_errors %}
                          <tr>
                            <td colspan="{% if product_class.track_stock %}10{% else %}7{% endif %}">
                              {% for error in stockrecord_form.non_field_errors %}
                                <span class="text-danger errorlist"><iconify-icon icon="fa:exclamation-triangle" width="1rem" height="1rem" aria-hidden="true"></iconify-icon>
                                {{ error }}</span>
                              {% endfor %}
                            </td>
                          </tr>
                        {% endif %}
                        <tr>
                          <td>{% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.partner nolabel=True %}</td>
                          <td>{% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.partner_sku nolabel=True %}</td>
                          {% if product_class.track_stock %}
                            <td>
                              {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.num_in_stock nolabel=True %}
                            </td>
                            <td>{{ stockrecord_form.instance.num_allocated|default:"-" }}</td>
                            <td>
                              {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.low_stock_threshold nolabel=True %}
                            </td>
                          {% endif %}
                          <td>
                            {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.price_currency nolabel=True %}
                          </td>
                          <td>{% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.price nolabel=True %}</td>
                          <td>
                            {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.id nolabel=True %}
                            {% include "oscar/dashboard/partials/form_field.html" with field=stockrecord_form.DELETE nolabel=True %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% endblock stockrecords_content %}
              </div>
            {% endblock stockrecords %}
            {% block child_products %}
              {% with children=product.children.all %}
                <div class="card tab-pane" id="child_products">
                  {% block child_products_content %}
                    <table class="table table-striped table-bordered align-middle">
                      <caption>
                        {% translate "Variants" %}
                        <button class="btn btn-primary icon-link"
                                {% if not product.can_be_parent %}disabled{% endif %}
                                name="action"
                                type="submit"
                                value="create-child"
                                data-loading-text="{% translate "Adding..." %}">
                          <iconify-icon icon="mdi:plus-circle" width="1rem" height="1rem" aria-hidden="true"></iconify-icon> {% translate "Add variant" %}
                        </button>
                      </caption>
                      {% if children %}
                        <tr>
                          <th>{% translate "Title" %}</th>
                          <th>{% translate "Attributes" %}</th>
                          <th>{% translate "Stock records" %}</th>
                          <th>{% translate "Is public?" %}</th>
                          <th>&nbsp;</th>
                        </tr>
                        {% for child in children %}
                          <tr>
                            <td>{{ child.get_title }}</td>
                            <td>{{ child.attribute_summary }}</td>
                            <td>{{ child.stockrecords.count }}</td>
                            <td>
                              {% if child.is_public %}
                                <span class="true">✔</span>
                              {% else %}
                                <span class="false">✘</span>
                              {% endif %}
                            </td>
                            <td>
                              <a href="{% url "dashboard:catalogue-product" pk=child.id %}"
                                 class="btn btn-primary">{% translate "Edit" %}</a>
                              <a href="{% url "dashboard:catalogue-product-delete" pk=child.id %}"
                                 class="btn btn-danger">{% translate "Delete" %}</a>
                            </td>
                          </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="5">
                            {% if product.can_be_parent %}
                              {% translate "This product does not have any variants." %}
                            {% else %}
                              {% translate "One can't add variants to this product at this point." %}
                              {% if product.pk is None %}
                                {% translate "Please save the product before trying to add variants." %}
                              {% elif product.has_stockrecords %}
                                {% translate "This is likely because this product still has stock records." %}
                              {% endif %}
                            {% endif %}
                          </td>
                        </tr>
                      {% endif %}
                    </table>
                  {% endblock child_products_content %}
                </div>
              {% endwith %}
            {% endblock child_products %}
            {% block recommended_products %}
              <div class="card tab-pane" id="product_recommended">
                {% block recommended_products_content %}
                  <table class="table table-striped table-bordered align-middle">
                    <caption>{% translate "Recommended products" %}</caption>
                    {{ recommended_formset.management_form }}
                    {{ recommended_formset.non_form_errors }}
                    {% for recommended_form in recommended_formset %}
                      <tr>
                        <td class="hstack">
                          {% include "oscar/dashboard/partials/form_fields_inline.html" with form=recommended_form wrapper_class="mb-0" %}
                        </td>
                      </tr>
                    {% endfor %}
                  </table>
                {% endblock recommended_products_content %}
              </div>
            {% endblock recommended_products %}
            {% block seo %}
              <div class="card tab-pane" id="seo">
                <div class="card-header">{% translate "Search engine optimisation" %}</div>
                <div class="card-body">
                  {% block seo_content %}
                    {% for field in form.seo_form_fields %}{{ field|as_crispy_field }}{% endfor %}
                  {% endblock seo_content %}
                </div>
              </div>
            {% endblock seo %}
          {% endblock tab_content %}
        </div>
      </div>
    </div>
    {% block fixed_actions_group %}
      <div class="form-actions-fixed align-items-center bg-dark column-gap-4 fixed-bottom hstack justify-content-end p-3">
        {% if parent %}
          <a class="btn btn-secondary"
             href="{% url "dashboard:catalogue-product-list" %}">{% translate "Cancel" %}</a>
          <button class="btn btn-outline-light"
                  name="action"
                  type="submit"
                  value="create-another-child"
                  data-loading-text="{% translate "Saving..." %}">
            {% translate "Save and add another variant" %}
          </button>
        {% endif %}
        <button class="btn btn-outline-light"
                name="action"
                type="submit"
                value="continue"
                data-loading-text="{% translate "Saving..." %}">{% translate "Save and continue editing" %}</button>
        <button class="btn btn-primary"
                name="action"
                type="submit"
                value="save"
                data-loading-text="{% translate "Saving..." %}">{% translate "Save" %}</button>
      </div>
    {% endblock fixed_actions_group %}
  </form>
{% endblock dashboard_content %}
{% block onbodyload %}
  {{ block.super }}
  oscar.dashboard.initTooltips();
{% endblock onbodyload %}
