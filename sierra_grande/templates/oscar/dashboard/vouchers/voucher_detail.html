{% extends "oscar/dashboard/layout.html" %}

{% load currency_filters i18n static %}


{% block title %}
  {{ voucher }} | {% translate "Vouchers" %} | {{ block.super }}
{% endblock title %}

{% block breadcrumbs %}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url "dashboard:index" %}">{% translate "Dashboard" %}</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url "dashboard:voucher-list" %}">{% translate "Vouchers" %}</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">{{ voucher }}</li>
    </ol>
  </nav>
{% endblock breadcrumbs %}

{% block main_header_content %}
  {{ voucher }}
{% endblock main_header_content %}

{% block dashboard_content %}
  <div class="card">
      <div class="card-header">
        <h4 class="card-title icon-link mb-0">
          <iconify-icon icon="bx:detail" width="1rem" height="1rem" aria-hidden="false"></iconify-icon>
          {% translate "Coupon details" %}
        </h4>
      </div>
      <div class="card-body">
        <div class="table-card table-responsive">
          {% include "oscar/dashboard/vouchers/partials/voucher_details_table.html" %}
        </div>
      </div>
  </div>


  <div class="card">
    <div class="card-header">
      <h4 class="card-title icon-link mb-0">
        <iconify-icon icon="fluent:attach-32-regular" width="1rem" height="1rem" aria-hidden="false"></iconify-icon>
        {% translate "Attached offers" %}
      </h4>
    </div>
    <div class="card-body">
      <div class="table-card table-responsive">
        <table class="table table-hover mb-0 align-middle">
          {% if voucher.offers.exists %}
            <thead>
              <tr>
                <th>{% translate "Offer name" %}</th>
                <th>{% translate "Start date" %}</th>
                <th>{% translate "End date" %}</th>
                <th>{% translate "Is available?" %}</th>
                <th>{% translate "Priority" %}</th>
                <th>{% translate "Incentive" %}</th>
                <th>{% translate "Condition" %}</th>
                <th>{% translate "Restrictions" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for offer in voucher.offers.all %}
                <tr>
                  <td>
                    <a href="{% url 'dashboard:offer-detail' pk=offer.pk %}">{{ offer.name }}</a>
                  </td>
                  <td>{{ offer.start_datetime|default:"-" }}</td>
                  <td>{{ offer.end_datetime|default:"-" }}</td>
                  <td>
                    {% if offer.is_available %}
                      <span class="badge bg-success-subtle text-success">{% translate "Yes" %}</span>
                    {% else %}
                      <span class="badge bg-danger">{% translate "No" %}</span>
                    {% endif %}
                  </td>
                  <td>{{ offer.priority }}</td>
                  <td>{{ offer.benefit.description|safe }}</td>
                  <td>{{ offer.condition.description|safe }}</td>
                  <td>
                    {% for restriction in offer.availability_restrictions %}
                      {% if not restriction.is_satisfied %}
                        <label class="badge bg-danger">{{ restriction.description }}</label>
                      {% else %}
                        {{ restriction.description }}
                        <br />
                      {% endif %}
                    {% endfor %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          {% else %}
            <tr>
              <td>{% translate "No offers are attached to this coupon." %}</td>
            </tr>
          {% endif %}
        </table>
      </div>
    </div>
  </div>
 
  <div class="card">
    <div class="card-header">
      <h4 class="card-title icon-link mb-0">
        <iconify-icon icon="streamline-ultimate:performance-increase" width="1rem" height="1rem" aria-hidden="false"></iconify-icon>
        {% translate "Coupon performance" %}
      </h4>
    </div>
    <div class="card-body">
      <div class="table-card table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <tbody>
            <tr>
              <th>{% translate "Number of basket additions" %}</th>
              <td>{{ voucher.num_basket_additions }}</td>
            </tr>
            <tr>
              <th>{% translate "Number of orders" %}</th>
              <td>{{ voucher.num_orders }}</td>
            </tr>
            <tr>
              <th>{% translate "Total discount" %}</th>
              <td>{{ voucher.total_discount|currency }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h4 class="card-title icon-link mb-0">
        <iconify-icon icon="mdi:recent" width="1rem" height="1rem" aria-hidden="false"></iconify-icon>
        {% translate "Recent orders" %}
      </h4>
    </div>
    <div class="card-body">
      <div class="table-card table-responsive">
        <table class="table table-hover mb-0 align-middle">
          {% if not discounts %}
            <tr>
              <td>{% translate "No orders have been placed that use this voucher." %}</td>
            </tr>
          {% else %}
            <thead>
              <tr>
                <th>{% translate "Order number" %}</th>
                <th>{% translate "Order total" %}</th>
                <th>{% translate "Discount" %}</th>
                <th>{% translate "Date placed" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for discount in discounts %}
                {% with order=discount.order %}
                  <tr>
                    <td>
                      <a href="{% url 'dashboard:order-detail' number=order.number %}">{{ order.number }}</a>
                    </td>
                    <td>{{ order.total_incl_tax|currency:order.currency }}</td>
                    <td>{{ discount.amount|currency:order.currency }}</td>
                    <td>{{ order.date_placed }}</td>
                  </tr>
                {% endwith %}
              {% endfor %}
            </tbody>
          {% endif %}
        </table>
      </div>
    </div>
  </div>

  {% block fixed_actions_group %}
    <div class="form-actions-fixed align-items-center bg-dark column-gap-4 fixed-bottom hstack justify-content-end p-3">
      <a href="{% if not voucher.voucher_set %}{% url 'dashboard:voucher-list' %}{% else %}{% url 'dashboard:voucher-set-detail' pk=voucher.voucher_set.pk %}{% endif %}" class="btn btn-outline-light">
        {% translate "Cancel" %}
      </a>
      <a class="btn btn-danger" href="{% url 'dashboard:voucher-delete' pk=voucher.id %}">
        {% if not voucher.voucher_set %}
          {% translate "Delete" %}
        {% else %}
          {% translate "Delete from set" %}
        {% endif %}
      </a>
      {% if not voucher.voucher_set %}
        <a class="btn btn-primary" href="{% url 'dashboard:voucher-update' pk=voucher.id %}">
          {% translate "Edit" %}
        </a>
      {% else %}
        <a class="btn btn-primary" href="{% url 'dashboard:voucher-set-update' pk=voucher.voucher_set.pk %}">
          {% translate "Edit set" %}
        </a>
      {% endif %}
    </div>
  {% endblock fixed_actions_group %}
{% endblock dashboard_content %}
